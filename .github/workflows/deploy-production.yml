name: Deploy Production (EC2)

on:
  push:
    branches: [main]

permissions:
  contents: read
  packages: write

jobs:
  build:
    uses: ./.github/workflows/_build_and_push.yml
    with:
      tag: prod-${{ github.sha }}
      latest_tag: prod-latest
    secrets: inherit

  deploy:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Compute lowercase owner
        id: img
        run: echo "OWNER_LC=${GITHUB_REPOSITORY_OWNER,,}" >> $GITHUB_OUTPUT

      # ------------------------------------------------
      # Prepare folders on EC2
      # ------------------------------------------------
      - name: Prepare project folders
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST_PROD }}
          username: ${{ secrets.SSH_USER_PROD }}
          key: ${{ secrets.SSH_KEY_PROD }}
          script: |
            sudo mkdir -p /var/www/api/camenu-qr-engine
            sudo chown -R ubuntu:ubuntu /var/www/api/camenu-qr-engine
            cd /var/www/api/camenu-qr-engine
            mkdir -p storage bootstrap_cache docker-compose/nginx

      # ------------------------------------------------
      # Upload docker-compose.yml
      # ------------------------------------------------
      - name: Upload docker-compose.yml
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST_PROD }}
          username: ${{ secrets.SSH_USER_PROD }}
          key: ${{ secrets.SSH_KEY_PROD }}
          source: "docker-compose.yml"
          target: "${{ secrets.PROJECT_DIR_PROD }}"

      # ------------------------------------------------
      # Upload nginx config
      # ------------------------------------------------
      - name: Upload nginx config
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST_PROD }}
          username: ${{ secrets.SSH_USER_PROD }}
          key: ${{ secrets.SSH_KEY_PROD }}
          source: "docker-compose/nginx/app.conf"
          target: "${{ secrets.PROJECT_DIR_PROD }}/docker-compose/nginx"

      # ------------------------------------------------
      # Upload .env from GitHub Secret
      # ------------------------------------------------
      - name: Upload .env
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST_PROD }}
          username: ${{ secrets.SSH_USER_PROD }}
          key: ${{ secrets.SSH_KEY_PROD }}
          script: |
            cat > "${{ secrets.PROJECT_DIR_PROD }}/.env" <<'EOF'
            ${{ secrets.ENV_PROD }}
            EOF

      # ------------------------------------------------
      # Deploy containers
      # ------------------------------------------------
      - name: SSH â†’ Pull & Deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST_PROD }}
          username: ${{ secrets.SSH_USER_PROD }}
          key: ${{ secrets.SSH_KEY_PROD }}
          script_stop: true
          script: |
            set -euo pipefail
            cd "${{ secrets.PROJECT_DIR_PROD }}"

            echo "ğŸ” Login to GHCR"
            echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u "${{ github.repository_owner }}" --password-stdin

            IMG="ghcr.io/${{ steps.img.outputs.OWNER_LC }}/camenu-qr-engine:prod-latest"
            echo "ğŸš€ Deploying $IMG"
            docker pull "$IMG"

            echo "ğŸ“¦ Starting containers"
            docker compose up -d --remove-orphans

            echo "â³ Waiting for app to be healthy..."
            for i in {1..60}; do
              cid=$(docker compose ps -q app || true)
              status="$(docker inspect --format='{{.State.Health.Status}}' "$cid" 2>/dev/null || true)"
              if [ "$status" = "healthy" ]; then
                echo "âœ… App is healthy"
                break
              fi
              if [ "$i" -eq 60 ]; then
                echo "âŒ App failed healthcheck"
                docker compose ps
                exit 1
              fi
              sleep 2
            done

            echo "ğŸ—„ Running migrations if needed"
            if docker compose exec -T app php artisan migrate:status | grep -q Pending; then
              docker compose exec -T app php artisan migrate --force
            else
              echo "âœ… No pending migrations"
            fi

            echo "ğŸ”§ Fix permissions"
            docker compose exec -T app chown -R www-data:www-data storage bootstrap/cache
            docker compose exec -T app chmod -R 775 storage bootstrap/cache

            echo "âš™ï¸ Clear caches"
            docker compose exec -T app php artisan optimize:clear || true

            echo "ğŸ§¹ Cleanup old images"
            docker image prune -f --filter "until=168h"

            echo "ğŸ‰ Deployment completed successfully"
