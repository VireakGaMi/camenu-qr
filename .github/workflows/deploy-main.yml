name: Deploy Main

on:
  push:
    branches: [main]

permissions:
  contents: read
  packages: write

jobs:
  # =========================
  # BUILD & PUSH IMAGE
  # =========================
  build:
    uses: ./.github/workflows/_build_and_push.yml
    with:
      tag: main-${{ github.sha }}
      latest_tag: latest
    secrets: inherit

  # =========================
  # DEPLOY TO SERVER
  # =========================
  deploy:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Compute image info
        id: img
        run: |
          echo "OWNER_LC=${GITHUB_REPOSITORY_OWNER,,}" >> $GITHUB_OUTPUT
          echo "IMAGE_NAME=camenu-engine" >> $GITHUB_OUTPUT

      # âœ… Create project directory
      - name: Create project dir
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST_PROD }}
          username: ${{ secrets.SSH_USER_PROD }}
          key: ${{ secrets.SSH_KEY_PROD }}
          script: |
            sudo mkdir -p ${{ secrets.PROJECT_DIR_PROD }}
            sudo chown -R $USER:$USER ${{ secrets.PROJECT_DIR_PROD }}

      # âœ… Upload docker-compose.yml
      - name: Upload docker-compose.yml
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST_PROD }}
          username: ${{ secrets.SSH_USER_PROD }}
          key: ${{ secrets.SSH_KEY_PROD }}
          source: "docker-compose.yml"
          target: "${{ secrets.PROJECT_DIR_PROD }}"

      # âœ… Upload nginx config
      - name: Upload nginx app.conf
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST_PROD }}
          username: ${{ secrets.SSH_USER_PROD }}
          key: ${{ secrets.SSH_KEY_PROD }}
          source: "docker-compose/nginx/app.conf"
          target: "${{ secrets.PROJECT_DIR_PROD }}"

      # âœ… SSH â†’ Pull & Deploy
      - name: SSH â†’ pull & deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST_PROD }}
          username: ${{ secrets.SSH_USER_PROD }}
          key: ${{ secrets.SSH_KEY_PROD }}
          script_stop: true
          script: |
            set -euo pipefail

            cd ${{ secrets.PROJECT_DIR_PROD }}

            mkdir -p docker-compose/nginx certbot/conf certbot/www

            echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io \
              -u "${{ github.repository_owner }}" --password-stdin

            IMG="ghcr.io/${{ steps.img.outputs.OWNER_LC }}/${{ steps.img.outputs.IMAGE_NAME }}:latest"
            echo "ðŸš€ Deploying $IMG"

            docker pull "$IMG"
            docker compose up -d --remove-orphans

            echo "â³ Waiting for app health..."
            for i in {1..60}; do
              cid=$(docker compose ps -q app || true)
              status=$(docker inspect --format='{{.State.Health.Status}}' "$cid" 2>/dev/null || true)
              [ "$status" = "healthy" ] && break
              sleep 2
            done

            docker compose exec -T app php artisan optimize:clear
            docker compose exec -T app php artisan migrate --force
            docker compose exec -T app php artisan config:cache
            docker compose exec -T app php artisan route:cache || true
            docker compose exec -T app php artisan view:cache

            docker image prune -f --filter "until=168h"
