name: Deploy main
on:
  push:
    branches: [main]

permissions:
  contents: read
  packages: write

jobs:
  build:
    uses: ./.github/workflows/_build_and_push.yml
    with:
      tag: main-${{ github.sha }}
      latest_tag: main-latest
    secrets: inherit

  deploy:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Compute lowercase owner
        id: img
        run: echo "OWNER_LC=${GITHUB_REPOSITORY_OWNER,,}" >> $GITHUB_OUTPUT

      # -------------------------
      # Upload docker-compose.yml
      # -------------------------
      - name: Upload docker-compose.yml
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST_PROD }}
          username: ${{ secrets.SSH_USER_PROD }}
          key: ${{ secrets.SSH_KEY_PROD }}
          source: "docker-compose.yml"
          target: "/var/www/api/camenu-qr-engine"

      # -------------------------
      # Upload nginx config
      # -------------------------
      - name: Upload nginx config
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST_PROD }}
          username: ${{ secrets.SSH_USER_PROD }}
          key: ${{ secrets.SSH_KEY_PROD }}
          source: "docker-compose/nginx/app.conf"
          target: "/var/www/api/camenu-qr-engine/docker-compose/nginx"

      # -------------------------
      # Deploy on server
      # -------------------------
      - name: SSH ‚Üí deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST_PROD }}
          username: ${{ secrets.SSH_USER_PROD }}
          key: ${{ secrets.SSH_KEY_PROD }}
          script_stop: true
          script: |
            set -e
            cd /var/www/api/camenu-qr-engine

            # Ensure directories exist (important for scp)
            mkdir -p docker-compose/nginx

            echo "üîê Login GHCR"
            echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io \
              -u "${{ github.repository_owner }}" --password-stdin

            echo "üì¶ Pull image"
            docker pull ghcr.io/${{ steps.img.outputs.OWNER_LC }}/camenu-engine:main-latest

            echo "üõë Stop old containers"
            docker compose down --remove-orphans

            echo "üöÄ Start containers"
            docker compose up -d

            echo "‚è≥ Waiting for MySQL port 3306..."
            set +e
            until docker compose exec -T mysql sh -c "nc -z localhost 3306"; do
              sleep 2
            done
            set -e

            echo "üßπ Laravel optimize"
            docker compose exec -T app php artisan optimize:clear

            echo "üóÑÔ∏è Migrate"
            docker compose exec -T app php artisan migrate --force

            echo "‚ö° Cache"
            docker compose exec -T app php artisan config:cache
            docker compose exec -T app php artisan route:cache || true
            docker compose exec -T app php artisan view:cache || true

            echo "üßΩ Cleanup images"
            docker image prune -f --filter "until=168h"

            echo "‚úÖ DEPLOY SUCCESS"
