name: Deploy Main

on:
  push:
    branches: [main]

permissions:
  contents: read
  packages: write

jobs:
  # =========================
  # BUILD & PUSH IMAGE
  # =========================
  build:
    uses: ./.github/workflows/_build_and_push.yml
    with:
      tag: main-${{ github.sha }}
      latest_tag: latest
    secrets: inherit

  # =========================
  # DEPLOY TO SERVER
  # =========================
  deploy:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Compute image info
        id: img
        run: |
          echo "OWNER_LC=${GITHUB_REPOSITORY_OWNER,,}" >> $GITHUB_OUTPUT
          echo "IMAGE_NAME=camenu-engine" >> $GITHUB_OUTPUT

      # =========================
      # CREATE PROJECT DIR
      # =========================
      - name: Create project dir
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST_PROD }}
          username: ${{ secrets.SSH_USER_PROD }}
          key: ${{ secrets.SSH_KEY_PROD }}
          script: |
            sudo mkdir -p ${{ secrets.PROJECT_DIR_PROD }}
            sudo chown -R $USER:$USER ${{ secrets.PROJECT_DIR_PROD }}

      # =========================
      # UPLOAD FILES
      # =========================
      - name: Upload docker-compose.yml
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST_PROD }}
          username: ${{ secrets.SSH_USER_PROD }}
          key: ${{ secrets.SSH_KEY_PROD }}
          source: "docker-compose.yml"
          target: "${{ secrets.PROJECT_DIR_PROD }}"

      - name: Upload nginx config
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST_PROD }}
          username: ${{ secrets.SSH_USER_PROD }}
          key: ${{ secrets.SSH_KEY_PROD }}
          source: "docker-compose/nginx/app.conf"
          target: "${{ secrets.PROJECT_DIR_PROD }}"

      # =========================
      # DEPLOY
      # =========================
      - name: SSH ‚Üí pull & deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST_PROD }}
          username: ${{ secrets.SSH_USER_PROD }}
          key: ${{ secrets.SSH_KEY_PROD }}
          script_stop: true
          script: |
            set -euo pipefail

            cd ${{ secrets.PROJECT_DIR_PROD }}

            echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io \
              -u "${{ github.repository_owner }}" --password-stdin

            IMG="ghcr.io/${{ steps.img.outputs.OWNER_LC }}/${{ steps.img.outputs.IMAGE_NAME }}:latest"
            echo "üöÄ Deploying $IMG"

            docker pull "$IMG"
            docker compose up -d --remove-orphans

            # =========================
            # CHECK APP_KEY (ENV SAFE)
            # =========================
            echo "üîé Checking APP_KEY..."
            if ! docker compose exec -T app sh -c '[ -n "$APP_KEY" ]'; then
              echo "‚ùå APP_KEY is missing in environment"
              echo "‚û°Ô∏è  Generate one manually and add it to .env"
              exit 1
            fi

            # =========================
            # SQLITE SETUP
            # =========================
            echo "üì¶ Ensuring SQLite database exists"
            docker compose exec -T app sh -c "
              mkdir -p database &&
              [ -f database/database.sqlite ] || touch database/database.sqlite
            "

            # =========================
            # LARAVEL OPTIMIZE
            # =========================
            echo "üßπ Clearing caches"
            docker compose exec -T app php artisan optimize:clear

            echo "üóÑÔ∏è Running migrations (SQLite)"
            docker compose exec -T app php artisan migrate

            echo "üîó Ensuring storage symlink"
            docker compose exec -T app sh -c \
              '[ -L public/storage ] || ln -s /var/www/storage/app/public /var/www/public/storage'

            echo "‚ö° Caching config"
            docker compose exec -T app php artisan config:cache
            docker compose exec -T app php artisan route:cache || true
            docker compose exec -T app php artisan view:cache

            # =========================
            # CLEANUP
            # =========================
            echo "üßΩ Cleaning old images"
            docker image prune -f --filter "until=168h"

            echo "‚úÖ Deployment completed successfully"
